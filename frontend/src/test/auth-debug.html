<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Supabase Auth 디버그 테스트</h1>
    
    <div class="debug-section">
        <h3>현재 상태</h3>
        <div id="authStatus">로딩 중...</div>
    </div>
    
    <div class="debug-section">
        <h3>테스트 버튼들</h3>
        <button onclick="checkSession()">세션 확인</button>
        <button onclick="loginWithGoogle()">구글 로그인</button>
        <button onclick="logout()">로그아웃</button>
        <button onclick="clearStorage()">스토리지 클리어</button>
        <button onclick="clearOutput()">출력 클리어</button>
    </div>
    
    <div class="debug-section">
        <h3>디버그 출력</h3>
        <div id="output"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://irjblvefaofqrujnjdps.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyamJsdmVmYW9mcXJ1am5qZHBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MTY2NTYsImV4cCI6MjA3MDk5MjY1Nn0.K8rQBQP3dCB06ISox9QwlgcexrRd3X3DQt9WHN_Ti90';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                flowType: 'pkce',
                debug: true
            }
        });
        
        let outputElement;
        let authStatusElement;
        
        function log(message) {
            if (!outputElement) {
                outputElement = document.getElementById('output');
            }
            const timestamp = new Date().toISOString();
            outputElement.textContent += `[${timestamp}] ${message}\n`;
            outputElement.scrollTop = outputElement.scrollHeight;
            console.log(message);
        }
        
        function updateAuthStatus(status) {
            if (!authStatusElement) {
                authStatusElement = document.getElementById('authStatus');
            }
            authStatusElement.innerHTML = status;
        }
        
        // 초기화
        async function init() {
            log('=== AUTH DEBUG 초기화 ===');
            
            // 현재 세션 체크
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                log('❌ 세션 가져오기 에러: ' + error.message);
                updateAuthStatus('<span class="error">에러: ' + error.message + '</span>');
            } else if (session) {
                log('✓ 기존 세션 발견: ' + session.user.email);
                updateAuthStatus('<span class="status">로그인됨: ' + session.user.email + '</span>');
            } else {
                log('ℹ️ 세션 없음');
                updateAuthStatus('로그아웃 상태');
            }
            
            // 인증 상태 변화 리스너
            supabase.auth.onAuthStateChange((event, session) => {
                log(`=== AUTH 상태 변화: ${event} ===`);
                if (session) {
                    log('새 세션: ' + JSON.stringify(session.user));
                    updateAuthStatus('<span class="status">로그인됨: ' + session.user.email + '</span>');
                } else {
                    log('세션 클리어됨');
                    updateAuthStatus('로그아웃 상태');
                }
            });
        }
        
        // 전역 함수들
        window.checkSession = async function() {
            log('=== 세션 확인 ===');
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                log('❌ 세션 확인 에러: ' + error.message);
            } else if (session) {
                log('✓ 세션 존재');
                log('사용자: ' + session.user.email);
                log('만료시간: ' + new Date(session.expires_at * 1000));
            } else {
                log('ℹ️ 세션 없음');
            }
        }
        
        window.loginWithGoogle = async function() {
            log('=== 구글 로그인 시작 ===');
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname,
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'select_account'
                    }
                }
            });
            
            if (error) {
                log('❌ 구글 로그인 에러: ' + error.message);
            } else {
                log('✓ 구글 로그인 요청 성공 (리다이렉트 예정)');
            }
        }
        
        window.logout = async function() {
            log('=== 로그아웃 시작 ===');
            const { error } = await supabase.auth.signOut({ scope: 'global' });
            if (error) {
                log('❌ 로그아웃 에러: ' + error.message);
            } else {
                log('✓ 로그아웃 성공');
            }
            
            // 세션 재확인
            setTimeout(async () => {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    log('⚠️ 경고: 로그아웃 후에도 세션이 남아있음');
                } else {
                    log('✓ 세션 완전히 클리어됨');
                }
            }, 1000);
        }
        
        window.clearStorage = function() {
            log('=== 스토리지 클리어 ===');
            
            // localStorage 클리어
            const localKeys = Object.keys(localStorage);
            const authKeys = localKeys.filter(key => 
                key.startsWith('supabase.auth.') || 
                key.startsWith('sb-') ||
                key.includes('auth') || 
                key.includes('google') ||
                key.includes('oauth')
            );
            log('localStorage 키 삭제: ' + authKeys.join(', '));
            authKeys.forEach(key => localStorage.removeItem(key));
            
            // sessionStorage 클리어
            const sessionKeys = Object.keys(sessionStorage);
            const authSessionKeys = sessionKeys.filter(key => 
                key.startsWith('supabase.auth.') || 
                key.startsWith('sb-') ||
                key.includes('auth') || 
                key.includes('google') ||
                key.includes('oauth')
            );
            log('sessionStorage 키 삭제: ' + authSessionKeys.join(', '));
            authSessionKeys.forEach(key => sessionStorage.removeItem(key));
            
            log('✓ 스토리지 클리어 완료');
        }
        
        window.clearOutput = function() {
            document.getElementById('output').textContent = '';
        }
        
        // 초기화 실행
        init();
    </script>
</body>
</html>