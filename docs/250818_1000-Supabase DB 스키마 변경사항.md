# Database Schema Changes - T-003 Implementation

**ì‚¬ì§„ ì—…ë¡œë“œ ë° ì•¨ë²” ê´€ë¦¬ìš© í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ ê°œë°œ** ì‘ì—…ì„ ë°˜ì˜í•œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.

---

## ğŸ“‹ ë³€ê²½ ê°œìš”

- **ìŠ¤í‚¤ë§ˆ ë²„ì „**: 1.0.0 â†’ **1.1.0**
- **ì—…ë°ì´íŠ¸ ë‚ ì§œ**: 2025-08-18
- **êµ¬í˜„ëœ ê¸°ëŠ¥**: ì‚¬ì§„ ì—…ë¡œë“œ, ì•¨ë²” ê´€ë¦¬, ë“œë˜ê·¸ ì•¤ ë“œë¡­, íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°, ì—…ë¡œë“œ ì§„í–‰ë¥  ì¶”ì 

---

## ğŸ†• ìƒˆë¡œ ì¶”ê°€ëœ í…Œì´ë¸”

### 1. `albums` í…Œì´ë¸” (ì‹ ê·œ)

**ëª©ì **: ì‚¬ì§„ì„ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì¡°ì§í™”í•˜ê³  ê´€ë¦¬

```sql
CREATE TABLE public.albums (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ê´€ë ¨ í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸**: `AlbumSelector.tsx`

**ì£¼ìš” ê¸°ëŠ¥**:
- ì‚¬ìš©ìë³„ ì•¨ë²” ìƒì„±/ê´€ë¦¬
- ì•¨ë²”ëª… ë° ì„¤ëª… ì €ì¥
- ì‚¬ì§„ê³¼ì˜ 1:N ê´€ê³„

### 2. `cist_question_templates` í…Œì´ë¸” (ì‹ ê·œ)

**ëª©ì **: AI ê¸°ë°˜ CIST ì§ˆë¬¸ ìƒì„±ì„ ìœ„í•œ í…œí”Œë¦¿ ì €ì¥

```sql
CREATE TABLE public.cist_question_templates (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    template_text TEXT NOT NULL,
    context_type VARCHAR(50) DEFAULT 'general',
    difficulty_level INTEGER DEFAULT 1 CHECK (difficulty_level BETWEEN 1 AND 5),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì£¼ìš” ê¸°ëŠ¥**:
- CIST ì¹´í…Œê³ ë¦¬ë³„ ì§ˆë¬¸ í…œí”Œë¦¿
- ë‚œì´ë„ ë° ì»¨í…ìŠ¤íŠ¸ íƒ€ì… ë¶„ë¥˜
- ë™ì  ì§ˆë¬¸ ìƒì„± ì§€ì›

### 3. `conversation_starters` í…Œì´ë¸” (ì‹ ê·œ)

**ëª©ì **: ì‚¬ì§„ ê¸°ë°˜ íšŒìƒ ëŒ€í™” ì‹œì‘ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ì €ì¥

```sql
CREATE TABLE public.conversation_starters (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    starter_text TEXT NOT NULL,
    context_type VARCHAR(50) DEFAULT 'general',
    emotion_tone VARCHAR(50) DEFAULT 'positive',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì£¼ìš” ê¸°ëŠ¥**:
- ìƒí™©ë³„ ëŒ€í™” ì‹œì‘ ë¬¸ì¥
- ê°ì • í†¤ ë¶„ë¥˜
- ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ì¶”ì²œ

### 4. `app_config` í…Œì´ë¸” (ì‹ ê·œ)

**ëª©ì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ë° ëŸ°íƒ€ì„ êµ¬ì„± ê´€ë¦¬

```sql
CREATE TABLE public.app_config (
    key VARCHAR(255) PRIMARY KEY,
    value JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì£¼ìš” ê¸°ëŠ¥**:
- ìŠ¤í‚¤ë§ˆ ë²„ì „ ì¶”ì 
- ê¸°ëŠ¥ í”Œë˜ê·¸ ê´€ë¦¬
- JSON í˜•íƒœì˜ ìœ ì—°í•œ ì„¤ì • ì €ì¥

---

## ğŸ“ ê¸°ì¡´ ì„¤ì •ì˜ Schema í†µí•©

### `memento-storage` ë²„í‚·ì´ Schemaì— í¬í•¨ë˜ì§€ ì•Šì•˜ë˜ ì´ìœ 

**ì´ì „ ì„¤ì • ë°©ì‹**:
- `memento-storage` ë²„í‚·ê³¼ ì •ì±…ì´ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ˜ë™ ì„¤ì •
- `database/schema.sql`ì—ëŠ” í…Œì´ë¸” êµ¬ì¡°ë§Œ í¬í•¨
- Storage ì„¤ì •ì€ ë³„ë„ ë¬¸ì„œ(`docs/Supabase í”„ë¡œì íŠ¸ ë° DB ì„¤ì •.md`)ì—ì„œ ì•ˆë‚´

**T-003ì—ì„œ ê°œì„ ëœ ì **:
- **ì¼ê´€ì„± í–¥ìƒ**: ëª¨ë“  ì¸í”„ë¼ ì„¤ì •ì„ í•˜ë‚˜ì˜ SQL íŒŒì¼ë¡œ í†µí•©
- **ìë™í™”**: ìŠ¤í‚¤ë§ˆ ì‹¤í–‰ ì‹œ Storage ë²„í‚·ê³¼ ì •ì±…ë„ ìë™ ìƒì„±
- **ë²„ì „ ê´€ë¦¬**: Storage ì„¤ì •ë„ ì½”ë“œë¡œ ê´€ë¦¬ë˜ì–´ ë³€ê²½ ì´ë ¥ ì¶”ì  ê°€ëŠ¥
- **ë°°í¬ ê°„ì†Œí™”**: ìƒˆ í™˜ê²½ êµ¬ì¶• ì‹œ SQL íŒŒì¼ í•˜ë‚˜ë¡œ ëª¨ë“  ì„¤ì • ì™„ë£Œ

**í†µí•© íš¨ê³¼**:
```sql
-- ì´ì œ schema.sql í•˜ë‚˜ë¡œ ëª¨ë“  ê²ƒì´ ì„¤ì •ë©ë‹ˆë‹¤
-- âœ… í…Œì´ë¸” ìƒì„±
-- âœ… ì¸ë±ìŠ¤ ìƒì„±  
-- âœ… RLS ì •ì±…
-- âœ… Storage ë²„í‚· ìƒì„±
-- âœ… Storage ì •ì±…
-- âœ… ë·° ìƒì„±
-- âœ… íŠ¸ë¦¬ê±° ì„¤ì •
```

---

## ğŸ”§ ê¸°ì¡´ í…Œì´ë¸” ìˆ˜ì •ì‚¬í•­

### `photos` í…Œì´ë¸” ì—…ë°ì´íŠ¸

#### ì¶”ê°€ëœ ì»¬ëŸ¼

```sql
-- í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•œ íŒŒì¼ëª… í•„ë“œ
filename VARCHAR(255) NOT NULL,                     -- ìƒì„±ëœ ê³ ìœ  íŒŒì¼ëª…
original_filename VARCHAR(255) NOT NULL,            -- ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì›ë³¸ íŒŒì¼ëª…

-- ì•¨ë²” ì—°ê²°
album_id UUID REFERENCES public.albums(id) ON DELETE SET NULL,
```

#### ìˆ˜ì •ëœ ì»¬ëŸ¼

```sql
-- í° íŒŒì¼ ì§€ì›ì„ ìœ„í•œ íƒ€ì… ë³€ê²½
file_size BIGINT,                                   -- INTEGER â†’ BIGINT ë³€ê²½
```

#### ê¸°ì¡´ ì»¬ëŸ¼ ìœ ì§€

```sql
file_name VARCHAR(255) NOT NULL,                    -- ë ˆê±°ì‹œ í˜¸í™˜ì„± ìœ ì§€
```

**ë³€ê²½ ì‚¬ìœ **:
- **filename/original_filename**: í”„ë¡ íŠ¸ì—”ë“œ `useFileUpload` í›…ê³¼ì˜ í˜¸í™˜ì„±
- **file_size BIGINT**: 10MB ì´ìƒ ëŒ€ìš©ëŸ‰ íŒŒì¼ ì§€ì›
- **album_id**: ì•¨ë²” ê¸°ë°˜ ì‚¬ì§„ ì¡°ì§í™” ê¸°ëŠ¥

---

## ğŸ“Š ì¸ë±ìŠ¤ ìµœì í™”

### ìƒˆë¡œ ì¶”ê°€ëœ ì¸ë±ìŠ¤

```sql
-- Albums ê´€ë ¨
CREATE INDEX idx_albums_user_id ON public.albums(user_id);
CREATE INDEX idx_albums_name ON public.albums(user_id, name);

-- Photos ìµœì í™”
CREATE INDEX idx_photos_album_id ON public.photos(album_id);
CREATE INDEX idx_photos_filename ON public.photos(filename);
CREATE INDEX idx_photos_is_favorite ON public.photos(user_id, is_favorite) WHERE is_favorite = true;
CREATE INDEX idx_photos_is_deleted ON public.photos(is_deleted) WHERE is_deleted = false;

-- CIST í…œí”Œë¦¿ ê´€ë ¨
CREATE INDEX idx_cist_templates_category ON public.cist_question_templates(category);
CREATE INDEX idx_cist_templates_context ON public.cist_question_templates(context_type);
```

**ìµœì í™” íš¨ê³¼**:
- ì•¨ë²”ë³„ ì‚¬ì§„ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ
- ì¦ê²¨ì°¾ê¸°/ì‚­ì œ í•„í„°ë§ ìµœì í™”
- CIST ì§ˆë¬¸ ê²€ìƒ‰ ì†ë„ ê°œì„ 

---

## ğŸ›¡ï¸ ë³´ì•ˆ ì •ì±… ê°•í™”

### ìƒˆë¡œìš´ RLS ì •ì±…

#### Albums í…Œì´ë¸”
```sql
-- ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
CREATE POLICY "Users can view own albums" ON public.albums
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own albums" ON public.albums
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own albums" ON public.albums
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own albums" ON public.albums
    FOR DELETE USING (auth.uid() = user_id);
```

#### Users í…Œì´ë¸” ê°•í™”
```sql
-- í”„ë¡œí•„ ìƒì„± ê¶Œí•œ ì¶”ê°€
CREATE POLICY "Users can insert own profile" ON public.users
    FOR INSERT WITH CHECK (auth.uid() = id);
```

### Storage ì •ì±… (ì‹ ê·œ + ê¸°ì¡´ í†µí•©)

```sql
-- ëª¨ë“  Storage ë²„í‚· ìƒì„± (PRIVATE for security)
INSERT INTO storage.buckets (id, name, public) VALUES
('memento-storage', 'memento-storage', false),  -- ê¸°ì¡´ ë²„í‚· (ì´ì œ ìŠ¤í‚¤ë§ˆì— í¬í•¨)
('photos', 'photos', false)                      -- ì‹ ê·œ ë²„í‚· (T-003)
ON CONFLICT (id) DO UPDATE SET public = EXCLUDED.public;

-- memento-storage ë²„í‚· ì •ì±… (ê¸°ì¡´ - ì´ì œ ìŠ¤í‚¤ë§ˆì— í¬í•¨)
CREATE POLICY "Users can upload own files to memento-storage" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'memento-storage' AND auth.uid()::text = (storage.foldername(name))[1]);

CREATE POLICY "Users can view own files in memento-storage" ON storage.objects
  FOR SELECT USING (bucket_id = 'memento-storage' AND auth.uid()::text = (storage.foldername(name))[1]);

-- photos ë²„í‚· ì •ì±… (ì‹ ê·œ - T-003)
CREATE POLICY "Users can upload own photos" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'photos' AND auth.uid()::text = (storage.foldername(name))[1]);

CREATE POLICY "Users can view own photos" ON storage.objects
  FOR SELECT USING (bucket_id = 'photos' AND auth.uid()::text = (storage.foldername(name))[1]);
```

---

## ğŸ” ìƒˆë¡œìš´ ë·° (Views)

### 1. `user_album_summary`

```sql
CREATE OR REPLACE VIEW public.user_album_summary AS
SELECT 
    a.id as album_id,
    a.name as album_name,
    a.description,
    a.user_id,
    COUNT(p.id) as photo_count,
    MAX(p.created_at) as last_photo_added
FROM public.albums a
LEFT JOIN public.photos p ON a.id = p.album_id AND p.is_deleted = false
GROUP BY a.id, a.name, a.description, a.user_id;
```

**ìš©ë„**: ì•¨ë²”ë³„ ì‚¬ì§„ ìˆ˜ ë° ìµœê·¼ ì—…ë°ì´íŠ¸ ì¡°íšŒ

### 2. `user_session_summary` (ê¸°ì¡´ ê°œì„ )

ì‚¬ìš©ìë³„ ì„¸ì…˜ í†µê³„ ë° CIST ì„±ê³¼ ìš”ì•½

### 3. `cist_performance_by_category` (ê¸°ì¡´ ê°œì„ )

CIST ì¹´í…Œê³ ë¦¬ë³„ ì„±ê³¼ ë¶„ì„

---

## âš¡ íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜ ì—…ë°ì´íŠ¸

### ìƒˆë¡œìš´ íŠ¸ë¦¬ê±°

```sql
-- ìƒˆë¡œ ì¶”ê°€ëœ í…Œì´ë¸”ë“¤ì— ëŒ€í•œ updated_at ìë™ ì—…ë°ì´íŠ¸
CREATE TRIGGER albums_updated_at
    BEFORE UPDATE ON public.albums
    FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at();

CREATE TRIGGER app_config_updated_at
    BEFORE UPDATE ON public.app_config
    FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at();
```

---

## ğŸ“ ë¬¸ì„œí™” ê°œì„ 

### ì£¼ì„ ì¶”ê°€

```sql
-- í…Œì´ë¸” ì„¤ëª…
COMMENT ON TABLE public.albums IS 'Photo albums for organizing user photos - NEW in T-003';

-- ì»¬ëŸ¼ ì„¤ëª…
COMMENT ON COLUMN public.photos.filename IS 'Generated unique filename for storage - NEW in T-003';
COMMENT ON COLUMN public.photos.original_filename IS 'Original user-uploaded filename - NEW in T-003';
COMMENT ON COLUMN public.photos.file_size IS 'File size in bytes (BIGINT for large files) - UPDATED in T-003';
COMMENT ON COLUMN public.photos.album_id IS 'Reference to albums table - NEW in T-003';
```

### ë²„ì „ ì¶”ì 

```sql
-- ìë™ ì‚½ì…ë˜ëŠ” ìŠ¤í‚¤ë§ˆ ì •ë³´
INSERT INTO public.app_config (key, value, description) VALUES
('schema_version', '"1.1.0"', 'Database schema version - T-003 implementation'),
('last_updated', '"2025-08-18"', 'Last schema update date'),
('features', '["photo_upload", "album_management", "drag_drop", "file_preview", "progress_tracking"]', 'Implemented features in current version');
```

---

## ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ í¬ì¸íŠ¸

### 1. íŒŒì¼ ì—…ë¡œë“œ (`useFileUpload` í›…)
- **ì‚¬ìš© í•„ë“œ**: `filename`, `original_filename`, `file_size` (BIGINT), `album_id`
- **Storage ê²½ë¡œ**: `photos/{user_id}/{filename}` ë˜ëŠ” `albums/{album_id}/{filename}`

### 2. ì•¨ë²” ê´€ë¦¬ (`AlbumSelector` ì»´í¬ë„ŒíŠ¸)
- **ì‚¬ìš© í…Œì´ë¸”**: `albums`
- **ê´€ë ¨ ë·°**: `user_album_summary`

### 3. íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (`FilePreview` ì»´í¬ë„ŒíŠ¸)
- **ì§€ì› í˜•ì‹**: JPEG, PNG, WebP (mime_type í•„ë“œë¡œ ê²€ì¦)
- **íŒŒì¼ í¬ê¸°**: ìµœëŒ€ 10MB (BIGINTë¡œ ì§€ì›)

### 4. ì—…ë¡œë“œ ì§„í–‰ë¥  (`UploadProgress` ì»´í¬ë„ŒíŠ¸)
- **Storage ì •ì±…**: ì‚¬ìš©ìë³„ ì—…ë¡œë“œ/ì‚­ì œ ê¶Œí•œ ë¶„ë¦¬
- **ì—ëŸ¬ ì²˜ë¦¬**: RLS ì •ì±… ê¸°ë°˜ ê¶Œí•œ ê²€ì¦

---

## ğŸ“ˆ ì„±ëŠ¥ ì˜í–¥

### ì¿¼ë¦¬ ì„±ëŠ¥ ê°œì„ 
- **ì•¨ë²”ë³„ ì‚¬ì§„ ì¡°íšŒ**: `idx_photos_album_id` ì¸ë±ìŠ¤ë¡œ ë¹ ë¥¸ í•„í„°ë§
- **íŒŒì¼ëª… ê²€ìƒ‰**: `idx_photos_filename` ì¸ë±ìŠ¤ë¡œ ì¤‘ë³µ ë°©ì§€
- **ì¦ê²¨ì°¾ê¸° ì¡°íšŒ**: ì¡°ê±´ë¶€ ì¸ë±ìŠ¤ë¡œ ì €ì¥ê³µê°„ ìµœì í™”

### ì €ì¥ê³µê°„ íš¨ìœ¨ì„±
- **ì¡°ê±´ë¶€ ì¸ë±ìŠ¤**: ì‚­ì œë˜ì§€ ì•Šì€ ì‚¬ì§„ë§Œ ì¸ë±ì‹±
- **JSONB ì„¤ì •**: ìœ ì—°í•œ ì„¤ì • ì €ì¥ìœ¼ë¡œ í…Œì´ë¸” ì¦ê°€ ë°©ì§€

---

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì—…ê·¸ë ˆì´ë“œ ì‹œ

1. **ë°±ì—… ìƒì„±** (í•„ìˆ˜)
2. **ìƒˆ ìŠ¤í‚¤ë§ˆ ì ìš©**
3. **ê¸°ì¡´ photos ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**:
   ```sql
   -- filenameê³¼ original_filenameì„ file_nameìœ¼ë¡œë¶€í„° ì„¤ì •
   UPDATE public.photos 
   SET filename = file_name, 
       original_filename = file_name 
   WHERE filename IS NULL;
   ```

### ìƒˆë¡œìš´ ì„¤ì¹˜ ì‹œ

1. **ì „ì²´ schema.sql ì‹¤í–‰**
2. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •** (`.env.local`)
3. **í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ í…ŒìŠ¤íŠ¸**

---

## âœ… ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Albums í…Œì´ë¸” ìƒì„± ë° RLS ì •ì±… ì ìš©
- [ ] Photos í…Œì´ë¸”ì— ìƒˆ ì»¬ëŸ¼ ì¶”ê°€ ì™„ë£Œ
- [ ] Storage ë²„í‚· `photos` ìƒì„± ë° ì •ì±… ì„¤ì •
- [ ] ëª¨ë“  ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ
- [ ] ë·°(Views) ìƒì„± ì™„ë£Œ
- [ ] íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ
- [ ] ìŠ¤í‚¤ë§ˆ ë²„ì „ ì •ë³´ ì‚½ì… ì™„ë£Œ
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ í…ŒìŠ¤íŠ¸ í†µê³¼

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ìƒ˜í”Œ ë°ì´í„° ì‚½ì…** (`seed_data.sql` ì—…ë°ì´íŠ¸)
2. **API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„** (ë°±ì—”ë“œ ì—°ë™)
3. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§** (ì¸ë±ìŠ¤ í™œìš©ë„ í™•ì¸)
4. **ì‚¬ìš©ì í…ŒìŠ¤íŠ¸** (ì‹¤ì œ ì‚¬ì§„ ì—…ë¡œë“œ ì‹œë‚˜ë¦¬ì˜¤)

ì´ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì„ í†µí•´ T-003ì—ì„œ êµ¬í˜„í•œ ëª¨ë“  í”„ë¡ íŠ¸ì—”ë“œ ê¸°ëŠ¥ì´ ì™„ë²½í•˜ê²Œ ì§€ì›ë©ë‹ˆë‹¤. ğŸš€