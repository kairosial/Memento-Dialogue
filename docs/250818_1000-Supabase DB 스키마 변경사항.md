# Database Schema Changes - T-003 Implementation

**사진 업로드 및 앨범 관리용 프론트엔드 컴포넌트 개발** 작업을 반영한 데이터베이스 스키마 변경사항입니다.

---

## 📋 변경 개요

- **스키마 버전**: 1.0.0 → **1.1.0**
- **업데이트 날짜**: 2025-08-18
- **구현된 기능**: 사진 업로드, 앨범 관리, 드래그 앤 드롭, 파일 미리보기, 업로드 진행률 추적

---

## 🆕 새로 추가된 테이블

### 1. `albums` 테이블 (신규)

**목적**: 사진을 카테고리별로 조직화하고 관리

```sql
CREATE TABLE public.albums (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**관련 프론트엔드 컴포넌트**: `AlbumSelector.tsx`

**주요 기능**:
- 사용자별 앨범 생성/관리
- 앨범명 및 설명 저장
- 사진과의 1:N 관계

### 2. `cist_question_templates` 테이블 (신규)

**목적**: AI 기반 CIST 질문 생성을 위한 템플릿 저장

```sql
CREATE TABLE public.cist_question_templates (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    template_text TEXT NOT NULL,
    context_type VARCHAR(50) DEFAULT 'general',
    difficulty_level INTEGER DEFAULT 1 CHECK (difficulty_level BETWEEN 1 AND 5),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**주요 기능**:
- CIST 카테고리별 질문 템플릿
- 난이도 및 컨텍스트 타입 분류
- 동적 질문 생성 지원

### 3. `conversation_starters` 테이블 (신규)

**목적**: 사진 기반 회상 대화 시작을 위한 프롬프트 저장

```sql
CREATE TABLE public.conversation_starters (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    starter_text TEXT NOT NULL,
    context_type VARCHAR(50) DEFAULT 'general',
    emotion_tone VARCHAR(50) DEFAULT 'positive',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**주요 기능**:
- 상황별 대화 시작 문장
- 감정 톤 분류
- 컨텍스트 기반 추천

### 4. `app_config` 테이블 (신규)

**목적**: 애플리케이션 설정 및 런타임 구성 관리

```sql
CREATE TABLE public.app_config (
    key VARCHAR(255) PRIMARY KEY,
    value JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**주요 기능**:
- 스키마 버전 추적
- 기능 플래그 관리
- JSON 형태의 유연한 설정 저장

---

## 📝 기존 설정의 Schema 통합

### `memento-storage` 버킷이 Schema에 포함되지 않았던 이유

**이전 설정 방식**:
- `memento-storage` 버킷과 정책이 Supabase 대시보드에서 수동 설정
- `database/schema.sql`에는 테이블 구조만 포함
- Storage 설정은 별도 문서(`docs/Supabase 프로젝트 및 DB 설정.md`)에서 안내

**T-003에서 개선된 점**:
- **일관성 향상**: 모든 인프라 설정을 하나의 SQL 파일로 통합
- **자동화**: 스키마 실행 시 Storage 버킷과 정책도 자동 생성
- **버전 관리**: Storage 설정도 코드로 관리되어 변경 이력 추적 가능
- **배포 간소화**: 새 환경 구축 시 SQL 파일 하나로 모든 설정 완료

**통합 효과**:
```sql
-- 이제 schema.sql 하나로 모든 것이 설정됩니다
-- ✅ 테이블 생성
-- ✅ 인덱스 생성  
-- ✅ RLS 정책
-- ✅ Storage 버킷 생성
-- ✅ Storage 정책
-- ✅ 뷰 생성
-- ✅ 트리거 설정
```

---

## 🔧 기존 테이블 수정사항

### `photos` 테이블 업데이트

#### 추가된 컬럼

```sql
-- 프론트엔드 호환성을 위한 파일명 필드
filename VARCHAR(255) NOT NULL,                     -- 생성된 고유 파일명
original_filename VARCHAR(255) NOT NULL,            -- 사용자가 업로드한 원본 파일명

-- 앨범 연결
album_id UUID REFERENCES public.albums(id) ON DELETE SET NULL,
```

#### 수정된 컬럼

```sql
-- 큰 파일 지원을 위한 타입 변경
file_size BIGINT,                                   -- INTEGER → BIGINT 변경
```

#### 기존 컬럼 유지

```sql
file_name VARCHAR(255) NOT NULL,                    -- 레거시 호환성 유지
```

**변경 사유**:
- **filename/original_filename**: 프론트엔드 `useFileUpload` 훅과의 호환성
- **file_size BIGINT**: 10MB 이상 대용량 파일 지원
- **album_id**: 앨범 기반 사진 조직화 기능

---

## 📊 인덱스 최적화

### 새로 추가된 인덱스

```sql
-- Albums 관련
CREATE INDEX idx_albums_user_id ON public.albums(user_id);
CREATE INDEX idx_albums_name ON public.albums(user_id, name);

-- Photos 최적화
CREATE INDEX idx_photos_album_id ON public.photos(album_id);
CREATE INDEX idx_photos_filename ON public.photos(filename);
CREATE INDEX idx_photos_is_favorite ON public.photos(user_id, is_favorite) WHERE is_favorite = true;
CREATE INDEX idx_photos_is_deleted ON public.photos(is_deleted) WHERE is_deleted = false;

-- CIST 템플릿 관련
CREATE INDEX idx_cist_templates_category ON public.cist_question_templates(category);
CREATE INDEX idx_cist_templates_context ON public.cist_question_templates(context_type);
```

**최적화 효과**:
- 앨범별 사진 조회 성능 향상
- 즐겨찾기/삭제 필터링 최적화
- CIST 질문 검색 속도 개선

---

## 🛡️ 보안 정책 강화

### 새로운 RLS 정책

#### Albums 테이블
```sql
-- 사용자별 데이터 격리
CREATE POLICY "Users can view own albums" ON public.albums
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own albums" ON public.albums
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own albums" ON public.albums
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own albums" ON public.albums
    FOR DELETE USING (auth.uid() = user_id);
```

#### Users 테이블 강화
```sql
-- 프로필 생성 권한 추가
CREATE POLICY "Users can insert own profile" ON public.users
    FOR INSERT WITH CHECK (auth.uid() = id);
```

### Storage 정책 (신규 + 기존 통합)

```sql
-- 모든 Storage 버킷 생성 (PRIVATE for security)
INSERT INTO storage.buckets (id, name, public) VALUES
('memento-storage', 'memento-storage', false),  -- 기존 버킷 (이제 스키마에 포함)
('photos', 'photos', false)                      -- 신규 버킷 (T-003)
ON CONFLICT (id) DO UPDATE SET public = EXCLUDED.public;

-- memento-storage 버킷 정책 (기존 - 이제 스키마에 포함)
CREATE POLICY "Users can upload own files to memento-storage" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'memento-storage' AND auth.uid()::text = (storage.foldername(name))[1]);

CREATE POLICY "Users can view own files in memento-storage" ON storage.objects
  FOR SELECT USING (bucket_id = 'memento-storage' AND auth.uid()::text = (storage.foldername(name))[1]);

-- photos 버킷 정책 (신규 - T-003)
CREATE POLICY "Users can upload own photos" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'photos' AND auth.uid()::text = (storage.foldername(name))[1]);

CREATE POLICY "Users can view own photos" ON storage.objects
  FOR SELECT USING (bucket_id = 'photos' AND auth.uid()::text = (storage.foldername(name))[1]);
```

---

## 🔍 새로운 뷰 (Views)

### 1. `user_album_summary`

```sql
CREATE OR REPLACE VIEW public.user_album_summary AS
SELECT 
    a.id as album_id,
    a.name as album_name,
    a.description,
    a.user_id,
    COUNT(p.id) as photo_count,
    MAX(p.created_at) as last_photo_added
FROM public.albums a
LEFT JOIN public.photos p ON a.id = p.album_id AND p.is_deleted = false
GROUP BY a.id, a.name, a.description, a.user_id;
```

**용도**: 앨범별 사진 수 및 최근 업데이트 조회

### 2. `user_session_summary` (기존 개선)

사용자별 세션 통계 및 CIST 성과 요약

### 3. `cist_performance_by_category` (기존 개선)

CIST 카테고리별 성과 분석

---

## ⚡ 트리거 및 함수 업데이트

### 새로운 트리거

```sql
-- 새로 추가된 테이블들에 대한 updated_at 자동 업데이트
CREATE TRIGGER albums_updated_at
    BEFORE UPDATE ON public.albums
    FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at();

CREATE TRIGGER app_config_updated_at
    BEFORE UPDATE ON public.app_config
    FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at();
```

---

## 📝 문서화 개선

### 주석 추가

```sql
-- 테이블 설명
COMMENT ON TABLE public.albums IS 'Photo albums for organizing user photos - NEW in T-003';

-- 컬럼 설명
COMMENT ON COLUMN public.photos.filename IS 'Generated unique filename for storage - NEW in T-003';
COMMENT ON COLUMN public.photos.original_filename IS 'Original user-uploaded filename - NEW in T-003';
COMMENT ON COLUMN public.photos.file_size IS 'File size in bytes (BIGINT for large files) - UPDATED in T-003';
COMMENT ON COLUMN public.photos.album_id IS 'Reference to albums table - NEW in T-003';
```

### 버전 추적

```sql
-- 자동 삽입되는 스키마 정보
INSERT INTO public.app_config (key, value, description) VALUES
('schema_version', '"1.1.0"', 'Database schema version - T-003 implementation'),
('last_updated', '"2025-08-18"', 'Last schema update date'),
('features', '["photo_upload", "album_management", "drag_drop", "file_preview", "progress_tracking"]', 'Implemented features in current version');
```

---

## 🚀 프론트엔드 연동 포인트

### 1. 파일 업로드 (`useFileUpload` 훅)
- **사용 필드**: `filename`, `original_filename`, `file_size` (BIGINT), `album_id`
- **Storage 경로**: `photos/{user_id}/{filename}` 또는 `albums/{album_id}/{filename}`

### 2. 앨범 관리 (`AlbumSelector` 컴포넌트)
- **사용 테이블**: `albums`
- **관련 뷰**: `user_album_summary`

### 3. 파일 미리보기 (`FilePreview` 컴포넌트)
- **지원 형식**: JPEG, PNG, WebP (mime_type 필드로 검증)
- **파일 크기**: 최대 10MB (BIGINT로 지원)

### 4. 업로드 진행률 (`UploadProgress` 컴포넌트)
- **Storage 정책**: 사용자별 업로드/삭제 권한 분리
- **에러 처리**: RLS 정책 기반 권한 검증

---

## 📈 성능 영향

### 쿼리 성능 개선
- **앨범별 사진 조회**: `idx_photos_album_id` 인덱스로 빠른 필터링
- **파일명 검색**: `idx_photos_filename` 인덱스로 중복 방지
- **즐겨찾기 조회**: 조건부 인덱스로 저장공간 최적화

### 저장공간 효율성
- **조건부 인덱스**: 삭제되지 않은 사진만 인덱싱
- **JSONB 설정**: 유연한 설정 저장으로 테이블 증가 방지

---

## 🔄 마이그레이션 가이드

### 기존 데이터베이스에서 업그레이드 시

1. **백업 생성** (필수)
2. **새 스키마 적용**
3. **기존 photos 데이터 마이그레이션**:
   ```sql
   -- filename과 original_filename을 file_name으로부터 설정
   UPDATE public.photos 
   SET filename = file_name, 
       original_filename = file_name 
   WHERE filename IS NULL;
   ```

### 새로운 설치 시

1. **전체 schema.sql 실행**
2. **환경 변수 설정** (`.env.local`)
3. **프론트엔드 연동 테스트**

---

## ✅ 검증 체크리스트

- [ ] Albums 테이블 생성 및 RLS 정책 적용
- [ ] Photos 테이블에 새 컬럼 추가 완료
- [ ] Storage 버킷 `photos` 생성 및 정책 설정
- [ ] 모든 인덱스 생성 완료
- [ ] 뷰(Views) 생성 완료
- [ ] 트리거 설정 완료
- [ ] 스키마 버전 정보 삽입 완료
- [ ] 프론트엔드 연동 테스트 통과

---

## 🎯 다음 단계

1. **샘플 데이터 삽입** (`seed_data.sql` 업데이트)
2. **API 엔드포인트 구현** (백엔드 연동)
3. **성능 모니터링** (인덱스 활용도 확인)
4. **사용자 테스트** (실제 사진 업로드 시나리오)

이 스키마 변경을 통해 T-003에서 구현한 모든 프론트엔드 기능이 완벽하게 지원됩니다. 🚀